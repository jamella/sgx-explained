\section{Memory Layout}
\label{sec:enclaves}

The central context of SGX is the \textit{enclave}, a protected environment
that contains the code and data pertaining to a security-sensitive computation.
This section provides an overview of the data structures used by an enclave.


\subsection{Memory Ownership vs Management}

% Access Control Requirements: SGX S 2.3

Enclaves use RAM to store their code and data, and need logical processors to
execute their code in order to perform the computation they were designed to
do. These computer resources are traditionally managed by privileged software,
such as hypervisors and operating system kernels.

In order for SGX to fit into this design, the code inside SGX enclaves is
subjected to the same address translation mechanism (\S~\ref{sec:paging}) as
the applications that enclose the enclaves. Enclave code runs at ring 3
(\S~\ref{sec:rings}), just like application code, so that it cannot
interfere with the privileged software that manages resources.

% Interactions with VMX: SGX S 6.5, 6.5.{1,2,3,4,5}

The rest of the paper will use the term \textit{system software} to refer to
the privileged software that manages resources. On most computers, this is an
operating system kernel. When VMX is in use, SGX resources are allocated by
the hypervisor to guest operating systems running in virtual machines.


\subsection{Enclaves in RAM}
\label{sec:prm}

% PRM: SGX S 3.5
% Interactions with DMA: SGX S 6.10
% Interactions with Memory Configuration: SGX S 6.11

The enclaves' code and data is stored in \textit{Processor Reserved Memory}
(PRM), a contiguous range of RAM that cannot be directly accessed by other
software, including privileged software such as the SMM code, the hypervisor,
and the OS kernel. The memory controller is integrated on the CPU die (see
Figure~\ref{fig:cpu_die}), so it can be trusted to prevent devices attached to
the system bus from performing DMA transfers to/from the PRM.

\begin{figure}[hbt]
  \center{\includegraphics[width=85mm]{figures/sgx_epc.pdf}}
  \caption{
    Enclave data is stored into the EPC, which is a subset of the PRM. The
    PRM is a contiguous range of RAM that cannot be accessed by system software
    or peripherals.
  }
  \label{fig:sgx_epc}
\end{figure}

Rejecting improper accesses to PRM is central to the SGX security model. The
designers were aware of that, and took clear steps to reduce the complexity of
the PRM checks, which in turn reduces the probability of bugs in the
implementation. The PRM must be set up to use SGX features and, once
configured, the PRM range cannot be changed. Furthermore, the PRM's size must
be an integer power of two, and its start address must be aligned to the same
power of two. The range restrictions reduce the complexity of checking if a RAM
address is in the PRM to a bitwise AND and an equality comparison.


\subsection{The Enclave Page Cache (EPC)}
\label{sec:epc}

% EPC and EPCM: SGX S 1.5, S 1.5.1, S 2.6.13, S 3.5, S 3.5.1

The contents of enclaves and the associated data structures are stored in the
\textit{Enclave Page Cache} (EPC), which is a subset of the PRM.

The SGX design handles multiple enclaves active at the same time, which is
necesssary in multi-tasking environments. This is achieved by having the EPC
split into 4kb pages, which can be associated to different enclaves. The system
software uses SGX instructions to allocate unused pages to enclaves, and to
free previously allocated EPC pages.

Normally, system software manages physical memory by directly modifying the
contents of page tables, and is responsible for ensuring that the state not
covered by cache coherency is synchronized across logical processors, by
performing TLB shootdowns (\S~\ref{sec:tlbs}, \S~\ref{sec:cache_coherence}). If
the system software does not perform a TLB shootdown correctly, application
software can experience race conditions. In the context of SGX, one such race
condition is having an EPC page simultaneously accessible by two different
enclaves, which would compromise the SGX security guarantees. Therefore, the
SGX instructions used for EPC management ensure that TLBs are invalidated
properly.

The SGX instructions that allocate a page to an enclave also copy data from a
page outside PRM to the EPC page. Non-enclave software is not permitted to
access the PRM, so the page allocation instructions provide the only
opportunity for system software to load the initial code and data into an
enclave.

\subsubsection{The Enclave Page Cache Map (EPCM)}
\label{sec:epcm}

The CPU maintains some metadata for each EPC page into the \textit{Enclave Page
Cache Map} (EPCM). The metadata tracks the enclave that each page was allocated
to, so the processor can prevent the code inside an enclave from accessing EPC
pages that belong to other enclaves.

% Access Control Requirements: SGX S 2.3

The EPCM metadata for a page includes the expected linear address used to
access the page (ENCLAVEADDRESS in Intel's documentation). This address must be
specified when a page is allocated, and cannot be changed until the page is
freed.

When the result of a memory address translation is a physical address of an EPC
page, the CPU ensures\footnote{A mismatch triggers a General Protection Fault.}
that the linear address used in the address translation matches the expected
linear address recorded in the page's EPCM entry. This prevents the system
software, which manages the page tables and EPT, from mapping pages to
unexpected addresses inside an enclave's address space.

A page's EPCM entry also records a \textit{type} for each page. The EPC that
store an enclave's code or data have their type set to \textit{regular}
(PT\_REG in the Intel documentation). Each page that is dedicated to an SGX key
data structure has its EPCM entry's type set to the kind of data structure
stored in the page. An EPC page's type is set when the page is allocated, and
is immutable throughout the page's lifetime.

Pages that store key SGX structures cannot be accessed directly, even by the
code executing inside their enclaves. Furthermore, the SGX instructions that
operate on SGX data structures check the EPCM type fields of their inputs
against the expected types. This type system prevents software from
intentionally or accidentally corrupting the key SGX data structures.

The type-based access restrictions have the desirable side-effect of hiding the
contents of the EPC pages holding key SGX structures from software, so the
internal layouts of these data structures can change across new CPU revisions.
Software cannot become dependent on a specific processor's implementation
details.

The SGX documentation does not state where the EPCM is stored, but we can
hypothesize that it is either an on-chip memory, like the L3 cache, or stored
in a PRM region that is not used by the EPC.


% EPCM table: SGX S 2.6.13

\begin{table}[hbt]
  \center{\begin{tabularx}{\columnwidth}{| l | r | X |}
  \hline
  \textbf{Field} & \textbf{Bits} & \textbf{Description}\\
  \hline
  VALID & 1 & 0 for un-allocated EPC pages \\
  \hline
  BLOCKED & 1 & page is being evicted (\S~\ref{TBD})\\
  \hline
  R & 1 & allow reads by enclave code\\
  \hline
  W & 1 & allow writes by enclave code\\
  \hline
  X & 1 & allow execution of code inside the page, inside enclave\\
  \hline
  EID & 64 & identifies the enclave owning the page\\
  \hline
  PT & 8 & the page type (SECS, TCS, VA, regular)\\
  \hline
  LINADDR & 48 & the linear address that should be used to access this page\\
  \hline
  \end{tabularx}}
  \caption{
    The fields in an EPCM entry.
  }
  \label{fig:epcm_entry}
\end{table}


% SECINFO: SGX S 2.6.5, S 2.6.5.{1,2}


\subsection{The SGX Enclave Control Structure (SECS)}

% Main data structures: SGX S 1.4
% SECS: SGX S 2.6.1, S 2.6.1.1, S 3.1
% ECREATE: SGX S 3.1, S 5.3
% Implicit access: SGX S 2.3

The first step in creating an enclave is using the \texttt{ECREATE} instruction
to designate a previously unused EPC page as the enclave's \textit{SGX Enclave
Control Structure} (SECS). All instructions that operate on an enclave access
the its control structure directly or indirectly.

The SECS page's type in EPCM is PT\_SECS, so the page is not directly
accessible by enclave code, and its

exact format is not specified in the SGX documentation. \texttt{ECREATE} does
read a 4kb page from non-EPC memory, the contents of which is used to specify
a number of enclave properties.

The SECS has two fields (BASEADDR and SIZE) that specify the enclave's linear
address space (ELRANGE in the Intel documentation). The enclave's starting
address has to be aligned by the enclave size, which simplifies checking if a
linear address belongs to an enclave or not, just like in the case of PRM
physical addresses.

The SECS also specifies the Intel architecture features used by the enclave
code, in the ATTRIBUTES field. This

\texttt{ECREATE} generates a 64-bit enclave ID (EID) that is stored at an
unspecified location inside the SECS. The EID is used to identify the enclave's
pages in the EPCM.



The SGX documentation does not reveal the exact layout of the SECS page in the
EPC.  \texttt{ECREATE}





% TCS: SGX S 2.6.2, S 2.6.2.{1,2,3,4}


% SSA: SGX S 2.6.3,
