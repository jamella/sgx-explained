\subsection{CPU Microcode}
\label{sec:microcode}

Intel's SGX patents disclose that all the SGX features, except for DRAM
encryption, were implemented as microcode extensions. The limitations of
microcode can explain seemingly arbitrary decisions in the SGX design, and a
thorough understanding is crucial to evaluating the feasibility of SGX
modification proposals. The first sub-section below presents the relevant facts
pertaining to microcode in Intel's optimization reference
\cite{intel2014optimization} and SDM. The following subsections summarize
information gleamed from Intel's patents and other researchers' findings.


\subsubsection{Official Information}
\label{sec:microcode_official}

% IntelÂ® Microarchitecture Code Name Sandy Bridge Pipeline Overview:
%     Optimization S 2.2.1
% The Front End: Optimization S 2.2.2

The x86 architecture defines a \textit{complex instruction set} (CISC).
However, virtually all modern CPUs are architected following \textit{reduced
instruction set} (RISC) principles. This is accomplished by having the
instruction decode stage (see Figure~\ref{fig:cpu_core}) break down each x86
instruction into \textit{micro-ops} for every instruction. The other CPU stages
work exclusively with micro-ops.

% Legacy Decode Pipeline (Instruction Decode): Optimization S 2.2.2.1
% Instruction Decode: Optimization S 2.3.2.4
% Front End Overview: Optimization S 2.4.2

The majority of x86 instructions are handled by the hardware decoding path,
which can emit at most 4 micro-ops per instruction. Complex instructions use a
slower decoding path that reads micro-ops from a \textit{microcode store ROM}
(MSROM).

% Microcode Update Facilities: SDM S 9.11
% Responsibilities of the BIOS: SDM 9.11.8.1

Modern Intel processors implement a microcode update facility. The SDM
describes microcode updates from the perspective of an OS kernel and
hypervisor. Each core can be updated independently, and the updates must be
re-applied on each boot cycle. A core can be updated multiple times, but each
update must have a bigger version than the core's current version. The current
SDM version at the time of this writing indicates that a microcode update is
up to 16 kB in size.

The update facility increases the attractiveness of developing architectural
features as microcode extensions \cite{intel2008genetic, intel2012clusters}.
The SGX enclave measurements produced by the processor include the microcode
version, hinting that the SGX designers anticipated the need to use microcode
updates.

\subsubsection{Organization}


% Microcode handles exceptions:
%   US 5,987,600 - 2:39-57, 4:13-27, 4:39-53, 4:65-5:6, 8:42-58, 10:54-60,
%                  11:18-42, 12:11-17, 12:54-58, 15:46-48, 15:59-62
%   US 5,889,982 - 11:40-42, 11:44-46,

% Microcode handles memory exceptions (#PF):
%   US 5,987,600 - 14:26-49, 14:55-61, 14:66-15:3
%   US 5,680,565 - 11:29-37,
%   US 5,889,982 - 14:41-43, 15:47-51,

% Microcode handles DTLB and PMH exceptions:
%   US 5,564,111 - Abstract 15-21, 1:46-59, 3:25-45, 7:47-53, 9:33-51,
%                  10:45-54, 10:57-63

% Microcode performs assisted PMH walk
%   US 5,680,565 - Abstract 1-2 and last 3 lines, 4:9-19, 4:22-28, 12:24-25,
%                  13:42-44, 13:48-54, 13:59-64, 14:12-21, 14:23-29, 14:61-66,
%                  15:1-12, 15:16-39

% Microcode handles events (exceptions and assists):
%   US 5.889,982 - 9:23-25, 9:34-42, 15:7-11, 15:27-55, 16:34-38, 16:57-17:3

% Microcode handles traps:
%   US 5,987,600 - 15:16-18, 15:36-40

% Microcode handles interrupts:
%   US 5,987,600 - 16:2-5, 16:18-21

% Microcode implementation details:
%   US 5,987,600 - 5:39-49, 5:53-6:32, 5:35-39, 5:42-53, 11:53-60, 11:64-67,
%                  12:6-10, 12:41-45, 14:15-19
%   US 5,680,565 - 2:53-56
%   US 5,889,982 - 6:49-65, 7:8-12, 10:11-14, 13:16-20,

% PMH implementation (stuffed loads)
%   US 5,680,565 - 2:60-3:3, 3:25-28, 3:33-52, 3:56, 3:58-4:4, 11:17-21,
%                  11:45-48, 11:50-52, 12:30-34, 12:20-22, 12:40-43, 13:20-22,
%                  14:42-58, 15:54-57

% DTLB implementation
%   US 5,564,111 - 1:26-29, 1:36-38, 3:7-21, 3:58-60, 5:36-41, 5:48-57,
%                  6:51-52, 6:55-7:7, 7:16-18, 7:23-24, 8:3-8, 8:39-40,
%                  9:66-10:4, 10:16-23

% Micro-ops table
%   US 7,451,121 - 1:23-25, 1:34-35, 2:64-65
%   US 8,099,587 - 3:1

% Event ROM
%   US 5,889,982 - 16:57-63, 16:66-17:3

% Microcode compression
%   US 7,451,121 - Abstract 1 and 10
%   US 8,099,587 - Abstract 1-3 and 7-10, 8:36-49, 11:10-17

\cite{intel1999exceptions} discloses that when an event (hardware exception or
interrupt) occurs, an event code is dispatched to the MSROM, which provides the
micro-ops that handle the event.


\cite{intel1997pmh} describes the operation of the PMH (\S~\ref{sec:tlbs}), and
discloses that the PMH uses a microcode assist when it needs to set the dirty
or accessed bits in a page table (\S~\ref{sec:paging}).

\cite{intel1999events} discloses that the microcode has an event ROM which
contains pointers to event handlers in the micro-ops table. The event ROM is
indexed by 6-bit event codes. The first 16 events are hardware exceptions, and
the others are microcode assists. \cite{intel1999events} explicitly mentions
page faults (\#PF) as an example of an exception, and the PMH-issued microcode
assist used to set accessed and dirty bits in the page tables.

\cite{intel1996dtlb} confirms that microcode is used to handle faults and
assists generated by the TLB (\S~\ref{sec:tlbs}) and PMH.

\cite{intel2008genetic} and \cite{intel2012clusters} disclose that the MSROM
contains a micro-ops table. \cite{intel2012clusters} states that tables have on
the order of 20,000 entries, and a micro-op has about 70 bits. Microcode may be
partially compressed.



\cite{hawkes2012microcode} used fault injection and timing analysis to conclude
that each recent Intel microcode update is signed with a 2048-bit RSA key and
a (possibly non-standard) 256-bit hash algorithm. This implies that Intel
already has a microcode implementation of RSA-2048 signature checking, which
may explain why SGX uses RSA signatures in its enclave structures.

\cite{chen2014microcode} sets out to analyze the structure of microcode used in
all x86 processors, but is unable to obtain any details about Intel's
microcode. Fortunately, even though the microcode structure is undocumented,
the 4 micro-ops limitation can be used to guess intelligently whether an
architectural feature is implemented in microcode. For example, it is safe to
assume that \texttt{XSAVE} (\S~\ref{sec:registers}), which was takes over 200
micro-ops on recent CPUs \cite{fog2014microops}, is most likely performed in
microcode, whereas simple arithmetic and memory access is handled directly by
hardware.

While Intel publishes the latest microcode versions for its CPUs, the release
notes associated with the updates are not publicly available. This is
unfortunate, as the release notes could be used to confirm guesses that certain
features are implemented in microcode. However, some information can be
inferred by reading through the Errata section in Intel's Specification Updates
\cite{intel2010errata, intel2015errata, intel2015errata2}. The phrase ``it is
possible for BIOS\footnote{Basic Input/Output System (BIOS)
is the predecessor of UEFI-based firmware. Most Intel documentation, including
the SDM, still uses the term BIOS to refer to firmware.} to contain a
workaround for this erratum'' generally means that a microcode update was
issued. For example, Errata AH in \cite{intel2010errata} implies that string
instructions (\texttt{REP MOV}) are implemented in microcode, which was
confirmed by Intel \cite{abraham2006repmov}.

Errata AH43 and AH91 in \cite{intel2010errata}, and AAK73 in
\cite{intel2015errata} imply that address translation (\S~\ref{sec:paging}) is
at least partially implemented in microcode. Errata AAK53, AAK63, and AAK70,
AAK178 in \cite{intel2015errata}, and BT138, BT210,  in \cite{intel2015errata2}
imply that VM entries and exits (\S~\ref{sec:faults}) are implemented in
microcode.
